{{- $page := .page -}}
{{- $site := .site -}}
{{- $showEmptyPages := $site.Params.showEmptyPages -}}
{{- $pattern := `\/docs\/\d+\.\d+` -}}
{{- $pagePath := replaceRE $pattern "" $page.RelPermalink -}}
{{- $pagePath := replace $pagePath "/docs" "" -}}
{{- $pagePath := replace $pagePath "/nightly" "" -}}
{{- $pagePath := replace $pagePath "/" "" -}}
{{- $parentActive := .parent_active | default false -}}
{{- $isHome := eq $pagePath "" -}}

{{- if not $isHome -}}
<ul>
  {{- range $index, $item := .menu -}}
    {{- $is := false -}}
    {{- $has := false -}}
    {{- $isActiveParent := false -}}

    {{- /* Check if current item or any of its descendants is active */ -}}
    {{- $path := replace $item.path "/" "" -}}
    {{- if eq $path $pagePath -}}
      {{- $has = true -}}
      {{- $is = true -}}
      {{- $isActiveParent = true -}}
    {{- end -}}

    {{- /* Check all descendants recursively */ -}}
    {{- if (isset $item "menu") -}}
      {{- range $child := $item.menu -}}
        {{- $childPath := replace $child.path "/" "" -}}
        {{- if eq $childPath $pagePath -}}
          {{- $has = true -}}
          {{- $isActiveParent = true -}}
        {{- end -}}
        {{- if (isset $child "menu") -}}
          {{- range $grandChild := $child.menu -}}
            {{- $grandChildPath := replace $grandChild.path "/" "" -}}
            {{- if eq $grandChildPath $pagePath -}}
              {{- $has = true -}}
              {{- $isActiveParent = true -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- if eq $pagePath "" -}}
      {{- $is = false -}}
      {{- $has = false -}}
    {{ end }}

    {{- if and (isset $item "menu") (ne $item.category "Label") (ne $item.category "Tab") -}}
      {{ if or $isActiveParent $parentActive -}}
        <li
          class="category-{{ $item.category }} {{ if $is }}active{{ end }} {{ if or $is $has (eq $item.category `Label`) (eq $item.category `Tab`) }}
            st-open
          {{ else }}
            st-collapsed
          {{ end }}">
          {{- if $item.path -}}
            {{- $prefixPath := strings.TrimLeft "/" $item.path -}}
            <a href="{{ $prefixPath | relURL }}" class="directory-link {{ if not $item.show }}paint-red{{ end }}">
              {{- $item.title -}}
            </a>
          {{- else -}}
            <a class="{{ if not $item.show }}paint-red{{ end }}">{{- $item.title -}}</a>
          {{- end -}}
          {{- partial "menu_recursive.html" (dict "menu" $item.menu "page" $page "site" $site "parent_active" (or $isActiveParent $parentActive)) -}}
        </li>
      {{ end }}
    {{- else if and ($item.show) (or (eq $item.category "Label") (eq $item.category "Tab")) -}}
      {{- if or $isActiveParent $parentActive (and $isHome (eq $item.title "Home")) -}}
        {{- if eq $item.category "Label" -}}
          <hr />
        {{- end -}}
        <h6 style="font-size: 15px;" class="{{ if and (eq $item.category "Tab") (eq $index 0) }}first-tab{{ end }}">{{ $item.title }}</h6>
        {{- if or $isActiveParent $parentActive -}}
          {{- partial "menu_recursive.html" (dict "menu" $item.menu "page" $page "site" $site "parent_active" true) -}}
        {{- end -}}
      {{- end -}}
    {{- else -}}
      {{ if or $isActiveParent $parentActive -}}
        <li class="st-file {{ if $is }}active{{ end }} {{ if not $item.show }}paint-red{{ end }}">
          {{- $prefixPath := strings.TrimLeft "/" $item.path -}}
          {{- $prefixPath := strings.TrimRight "/" $item.path -}}
          {{- $prefixPath := replace $prefixPath "--" "-&-" -}}
          {{- $prefixMD := printf "%s.md" $prefixPath -}}

          {{- if $prefixPath -}}
            <a href="{{ ref $page $prefixMD }}" class="{{ if not $item.show }}paint-red{{ end }}">
              {{- $item.title -}}
            </a>
          {{- else -}}
            {{- $item.title -}}
          {{- end -}}

          {{ if not $item.path }}
            {{- warnf "Found page without path %q" $item.title -}}
          {{ end }}
        </li>
      {{- end -}}
    {{- end -}}
  {{- end -}}
</ul>
{{- end -}}
