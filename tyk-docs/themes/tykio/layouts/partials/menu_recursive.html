{{ $page := .page }}
{{ $site := .site }}

{{ $pagePath := replace $page.RelPermalink "/docs" "" }}
{{ $pagePath := replace $pagePath "/nightly" "" }}
{{ $pagePath := replace $pagePath "/" "" }}

<ul>
{{ range .menu }}  
  {{ $is := false }}
  {{ $has := false }}

  {{ $path := replace .path "/" "" }}
  {{ if eq $path $pagePath }}
    {{ $has = true }}
    {{ $is = true }}
  {{ end }}

  {{ if (isset . "menu") }}
    {{ range .menu }}
      {{ $path := replace .path "/" "" }}
      {{ if eq $path $pagePath }}
        {{ $has = true }}
      {{ end }}
      {{ if (isset . "menu") }}
        {{ range .menu }}
          {{ $path := replace .path "/" "" }}
          {{ if eq $path $pagePath }}
            {{ $has = true }}
          {{ end }}
          {{ if (isset . "menu") }}
            {{ range .menu }}
              {{ $path := replace .path "/" "" }}
              {{ if eq $path $pagePath }}
                {{ $has = true }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if (isset . "menu") }} 
    <li class="category-{{.category}} {{if $is}} active {{end}} {{ if or $is $has (eq .category `Label`)}} st-open {{else}} st-collapsed {{end}}">
      {{ if .path }}
      <a href="{{ .path | relURL }}">
        {{ .title }}
      </a>
      {{ else }}
        <a>{{ .title }}</a>
      {{ end }}
        <!-- If the menu item has children, include this partial template again (recursively) -->
        {{ partial "menu_recursive.html" (dict "menu" .menu "page" $page "site" $site) }}
    </li>
  {{ else }}
    <li class="st-file {{if $is}} active {{end}} ">
      <a href="{{ .path | relURL }}">
        {{ .title }}
      </a>
    </li>
  {{ end }}
{{ end }}
</ul>
