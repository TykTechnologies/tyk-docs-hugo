---
date: 2023-08-29T13:32:12Z
title: OpenTelemetry With Jaeger
tags: ["distributed tracing", "OpenTelemetry", "Jaeger"]
description: "This guide explains how to setup Tyk Gateway with OpenTelemetry and Jager to enhance API Observability"
---

This quick start guide offers a detailed, step-by-step walkthrough for configuring Tyk Gateway OSS with OpenTelemetry and [Jaeger](https://www.jaegertracing.io/) to significantly improve API observability. We will cover the installation of essential components, their configuration, and the process of ensuring seamless integration.

Let's get started with deploying Tyk using [Docker]({{< ref "otel_jaeger" >}}#deploying-tyk-gateway-and-jaeger-on-docker). Further instructions for [Kubernetes]({{< ref "otel_jaeger" >}}#deploying-tyk-gateway-and-jaeger-on-kubernetes) deployment are detailed below.

## Deploying Tyk Gateway and Jaeger on Docker

### Prerequisites

Ensure the following prerequisites are met before proceeding:

- [Docker installed on your machine](https://docs.docker.com/get-docker/)
- Gateway v5.2.0 or higher

### Step 1: Create the Docker-Compose File for Jaeger

Save the following YAML configuration in a file named docker-compose.yml:

```yaml
version: "2"
services:
  # Jaeger: Distributed Tracing System
  jaeger-all-in-one:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP receiver
```

This configuration sets up Jaeger's all-in-one instance with ports exposed for Jaeger UI and the OTLP receiver.

### Step 2: Deploy a Test API Definition

If you haven't configured any APIs yet, follow these steps:

- Create a subdirectory named apps in the current directory.
- Create a new file named `apidef-hello-world.json``.
- Copy the provided simple API definition below into the `apidef-hello-world.json`` file:


```json
{ 
    "name": "Hello-World",
    "slug": "hello-world",
    "api_id": "Hello-World",
    "org_id": "1",
    "use_keyless": true,
    "detailed_tracing": true,
    "version_data": {
      "not_versioned": true,
      "versions": {
        "Default": {
          "name": "Default",
          "use_extended_paths": true
        }
      }
    },
    "proxy": {
      "listen_path": "/hello-world/",
      "target_url": "http://echo.tyk-demo.com:8080/",
      "strip_listen_path": true
    },
    "active": true
}
```

This API definition sets up a basic API named Hello-World for testing purposes, configured to proxy requests to `http://echo.tyk-demo.com:8080/`.

### Step 3: Run Tyk Gateway OSS with OpenTelemetry Enabled

To run Tyk Gateway with OpenTelemetry integration, extend the previous Docker Compose file to include Tyk Gateway and Redis services. Follow these steps:

- Add the following configuration to your existing docker-compose.yml file:

```yaml
# ... Existing docker-compose.yml content for jaeger

tyk:
  image: tykio/tyk-gateway:v5.2.0
  ports:
    - 8080:8080
  environment:
    - TYK_GW_OPENTELEMETRY_ENABLED=true
    - TYK_GW_OPENTELEMETRY_EXPORTER=grpc
    - TYK_GW_OPENTELEMETRY_ENDPOINT=jaeger-all-in-one:4317
  volumes:
    - ${TYK_APPS:-./apps}:/opt/tyk-gateway/apps
  depends_on:
    - redis

redis:
  image: redis:4.0-alpine
  ports:
    - 6379:6379
  command: redis-server --appendonly yes
```

- Navigate to the directory containing the docker-compose.yml file in your terminal.
- Execute the following command to start the services:

```bash
docker-compose up
```


### Step 4: Explore OpenTelemetry Traces in Jaeger

- Start by sending a few requests to the API endpoint configured in Step 2:
``
curl http://localhost:8080/hello-world/ -i
``

- Access Jaeger at *http://localhost:16686*.
- In Jaeger's interface:
  - Select the service named tyk-gateway.
  - Click the *Find Traces* button.

You should observe traces generated by Tyk Gateway, showcasing the distributed tracing information.

{{< img src="/img/distributed-tracing/opentelemetry/api-gateway-trace-tyk-jaeger.png" alt="Tyk API Gateway distributed trace in Jaeger" >}}

Select a trace to visualize its corresponding internal spans:

{{< img src="/img/distributed-tracing/opentelemetry/api-gateway-trace-tyk-jaeger-spans.png" alt="Tyk API Gateway spans in Jaeger" >}}



</br>
</br>


## Deploying Tyk Gateway and Jaeger on Kubernetes

### Prerequisites

Ensure the following prerequisites are in place before proceeding:

- A functional Kubernetes cluster
- kubectl and helm CLI tools installed

### Step 1: Install Jaeger Operator

For the purpose of this tutorial, we will use jaeger-all-in-one, which includes the Jaeger agent, collector, query, and UI in a single pod with in-memory storage. This deployment is intended for development, testing, and demo purposes. Other deployment patterns can be found in the [Jaeger Operator documentation](https://www.jaegertracing.io/docs/1.51/operator/#deployment-strategies).


1. Install the cert-manager release manifest (required by Jaeger)

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.2/cert-manager.yaml
```

2. Install [Jaeger Operator](https://www.jaegertracing.io/docs/latest/operator/)).

```bash
kubectl create namespace observability
kubectl create -f https://github.com/jaegertracing/jaeger-operator/releases/download/v1.51.0/jaeger-operator.yaml -n observability

```

3. After the Jaeger Operator is deployed to the `observability` namespace, create a Jaeger instance:

```bash
kubectl apply -n observability -f - <<EOF
apiVersion: jaegertracing.io/v1
kind: Jaeger
metadata:
  name: jaeger-all-in-one
EOF
```


### Step 2: Deploy Tyk Gateway using Helm

To install or upgrade [Tyk Gateway OSS using Helm](https://github.com/TykTechnologies/tyk-charts/tree/main/tyk-oss), execute the following commands:

```bash
NAMESPACE=tyk
APISecret=foo
TykVersion=v5.2.0

helm upgrade tyk-redis oci://registry-1.docker.io/bitnamicharts/redis -n $NAMESPACE --create-namespace --install
helm repo add tyk-helm https://helm.tyk.io/public/helm/charts/
helm repo update
helm upgrade tyk-otel tyk-helm/tyk-oss -n $NAMESPACE --create-namespace --devel \
  --install \
  --set global.secrets.APISecret="$APISecret" \
  --set global.redis.addrs="{tyk-redis-master.$NAMESPACE.svc.cluster.local:6379}" \
  --set global.redis.pass="$(kubectl get secret --namespace $NAMESPACE tyk-redis -o jsonpath='{.data.redis-password}' | base64 -d)" \
  --set tyk-gateway.gateway.image.tag=$TykVersion \
  --set "tyk-gateway.gateway.extraEnvs[0].name=TYK_GW_OPENTELEMETRY_ENABLED" \
  --set-string "tyk-gateway.gateway.extraEnvs[0].value=true" \
  --set "tyk-gateway.gateway.extraEnvs[1].name=TYK_GW_OPENTELEMETRY_ENDPOINT" \
  --set "tyk-gateway.gateway.extraEnvs[1].value=jaeger-all-in-one-collector.observability.svc.cluster.local:4317"
```

Tyk Gateway is now accessible through service gateway-svc-tyk-oss-tyk-gateway at port 8080 and exports the OpenTelemetry traces to the `jaeger-all-in-one-collector` service.

### Step 3: Deploy Tyk Operator

Deploy Tyk Operator to manage APIs in your cluster:

```bash
kubectl create namespace tyk-operator-system
kubectl create secret -n tyk-operator-system generic tyk-operator-conf \
  --from-literal "TYK_AUTH=$APISecret" \
  --from-literal "TYK_ORG=org" \
  --from-literal "TYK_MODE=ce" \
  --from-literal "TYK_URL=http://gateway-svc-tyk-otel-tyk-gateway.tyk.svc.cluster.local:8080" \
  --from-literal "TYK_TLS_INSECURE_SKIP_VERIFY=true"
helm install tyk-operator tyk-helm/tyk-operator -n tyk-operator-system

```

### Step 4: Deploy a Test API Definition

Save the following API definition as `apidef-hello-world.yaml`:

```yaml
apiVersion: tyk.tyk.io/v1alpha1
kind: ApiDefinition
metadata:
 name: hello-world
spec:
 name: hello-world
 use_keyless: true
 protocol: http
 active: true
 proxy:
   target_url: http://echo.tyk-demo.com:8080/
   listen_path: /hello-world
   strip_listen_path: true
```

To apply this API definition, run the following command:

```bash
kubectl apply -f apidef-hello-world.yaml 
```

This step deploys an API definition named hello-world using the provided configuration. It enables a keyless HTTP API proxying requests to http://echo.tyk-demo.com:8080/ and accessible via the path /hello-world.

### Step 5: Explore OpenTelemetry traces in Jaeger

You can use the kubectl `port-forward command` to access Tyk and Jaeger services running in the cluster from your local machine's localhost:

For Tyk API Gateway:

```bash
kubectl port-forward service/gateway-svc-tyk-otel-tyk-gateway 8080:8080 -n tyk
```

For Jaeger:

```bash
kubectl port-forward service/jaeger-all-in-one-query 16686 -n observability
```

Begin by sending a few requests to the API endpoint configured in step 2: 

```bash
curl http://localhost:8080/hello-world/ -i
```

Next, navigate to Jaeger on `http://localhost:16686`, select the ´service´ called ´tyk-gateway´and click on the button ´Find traces´. You should see traces generated by Tyk:

{{< img src="/img/distributed-tracing/opentelemetry/api-gateway-trace-tyk-jaeger.png" alt="Tyk API Gateway distributed trace in Jaeger" >}}

Click on a trace to view all its internal spans:

{{< img src="/img/distributed-tracing/opentelemetry/api-gateway-trace-tyk-jaeger-spans.png" alt="Tyk API Gateway spans in Jaeger" >}}


