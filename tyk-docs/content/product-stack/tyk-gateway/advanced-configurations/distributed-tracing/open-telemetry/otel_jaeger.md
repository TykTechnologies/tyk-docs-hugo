---
date: 2023-08-29T13:32:12Z
title: Exporting OpenTelemetry Distributed Traces to Jaeger
tags: ["distributed tracing", "OpenTelemetry", "Jaeger"]
description: "This guide explains how to setup Tyk Gateway with OpenTelemetry and Jager to enhance API Observability"
---

This guide demonstrates the configuration steps required to set up Tyk API Gateway with Jaeger for efficient distributed tracing and enhanced API observability. Whether you’re using Tyk API Gateway in an open-source (OSS) or commercial deployment, the configuration options remain identical.

This capability is not yet available for Gateways hosted in Tyk Cloud.

## Deploying Tyk Gateway and Jaeger on Docker

### Prerequisites

- [Docker installed on your machine](https://docs.docker.com/get-docker/)
- Gateway v5.2.0 or higher

### Step 1: Create the Docker-Compose File for Jaeger

Save the following YAML configuration to a file named `docker-compose.yml`.

```yaml
version: "2"
services:
  # Jaeger: Distributed Tracing System
  jaeger-all-in-one:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP receiver
```

### Step 2: Configure a test API

If you don't have any APIs configured yet, create a subdirectory called `apps` in the current directory. Create a new file `apidef-hello-world.json` and copy this very simple API definition for testing purposes:

```json
{ 
    "name": "Hello-World",
    "slug": "hello-world",
    "api_id": "Hello-World",
    "org_id": "1",
    "use_keyless": true,
    "detailed_tracing": true,
    "version_data": {
      "not_versioned": true,
      "versions": {
        "Default": {
          "name": "Default",
          "use_extended_paths": true
        }
      }
    },
    "proxy": {
      "listen_path": "/hello-world/",
      "target_url": "http://echo.tyk-demo.com:8080/",
      "strip_listen_path": true
    },
    "active": true
}
```

### Step 3: Run OSS Tyk Gateway with OpenTelemetry enabled

To run Tyk Gateway, you can extend the previous Docker Compose file to include Tyk Gateway and Redis services. Make sure to include the environment variables to configure OpenTelemetry in Tyk Gateway.

```yaml
# ... Existing docker-compose.yml content for jaeger

tyk:
  image: tykio/tyk-gateway:v5.2.0
  ports:
    - 8080:8080
  environment:
    - TYK_GW_OPENTELEMETRY_ENABLED=true
    - TYK_GW_OPENTELEMETRY_EXPORTER=grpc
    - TYK_GW_OPENTELEMETRY_ENDPOINT=otel-collector:4317
  volumes:
    - ${TYK_APPS:-./apps}:/opt/tyk-gateway/apps
  depends_on:
    - redis

redis:
  image: redis:4.0-alpine
  ports:
    - 6379:6379
  command: redis-server --appendonly yes
```

Run the services by navigating to the directory containing the docker-compose.yml file and executing:

```bash
docker-compose up
```


### Step 4: Explore OpenTelemetry traces in Jaeger

Begin by sending a few requests to the API endpoint configured in step 2: 
``
http://localhost:8080/hello-world/
``

Next, navigate to Jaeger on `http://localhost:16686`, select the ´service´ called ´tyk-gateway´and click on the button ´Find traces´. You should see traces generated by Tyk:

{{< img src="/img/distributed-tracing/opentelemetry/api-gateway-trace-tyk-jaeger.png" alt="Tyk API Gateway distributed trace in Jaeger" >}}

Click on a trace to view all its internal spans:

{{< img src="/img/distributed-tracing/opentelemetry/api-gateway-trace-tyk-jaeger-spans.png" alt="Tyk API Gateway spans in Jaeger" >}}



</br>
</br>


## Deploying Tyk Gateway with OpenTelemetry and Jaeger on Kubernetes

### Prerequisites

- A running Kubernetes cluster
- kubectl and helm CLI tools installed

### Step 1: Install Jaeger Operator

For the purpose of POC/demo, we can use jaeger-all-in-one, which includes the Jaeger agent, collector, query, and UI in a single pod with in-memory storage.

#### Installation via Jaeger Operator

1. Follow the Jaeger Operator installation guide: [Jaeger Operator Documentation](https://www.jaegertracing.io/docs/1.48/operator/).

2. After the Jaeger Operator is deployed to the `observability` namespace, create a Jaeger instance:

```bash

kubectl apply -n observability -f - <<EOF
apiVersion: jaegertracing.io/v1
kind: Jaeger
metadata:
  name: jaeger-all-in-one
EOF
```

{{< note success >}}
**Note**

The Jaeger UI will be available at `jaeger-all-in-one-query:16686`.
{{< /note >}}

### Step 2: Configure OpenTelemetry Collector

#### 1. Create a configuration YAML file, `otel-collector-config.yaml`:

```yaml
mode: deployment
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: ${env:MY_POD_IP}:4317
  processors:
    batch: {}
  exporters:
    otlp:
      endpoint: "jaeger-all-in-one-collector.observability.svc.cluster.local:4317"
      tls:
        insecure: true
  service:
    pipelines:
      traces:
        receivers: [otlp]
        processors: [batch]
        exporters: [jaeger]
```

#### 2. Install the OpenTelemetry Collector via Helm:

```bash
helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
helm install tyk-otel-collector open-telemetry/opentelemetry-collector -n tyk --version 0.62.0 -f otel-collector-config.yaml
```

### Step 3: Configure Tyk Gateway

#### 1. Configure OpenTelemetry in Tyk by setting environment variables:

You can enable OpenTelemetry in Tyk by modifying its configuration as follows:

```json
{
  "opentelemetry": {
    "enabled": true,
    "exporter": "grpc",
    "endpoint": "tyk-otel-collector-opentelemetry-collector:4317"
  }
}
```

Alternatively, set the environment variables in your deployment:

```bash
TYK_GW_OPENTELEMETRY_ENABLED=true
TYK_GW_OPENTELEMETRY_EXPORTER=grpc
TYK_GW_OPENTELEMETRY_ENDPOINT=tyk-otel-collector-opentelemetry-collector:4317
```

#### 2. Install/Upgrade Tyk using Helm:

To install or upgrade Tyk using Helm, execute the following commands:

```bash
NAMESPACE=tyk
APISecret=foo
TykVersion=v5.2.0

helm upgrade tyk-redis oci://registry-1.docker.io/bitnamicharts/redis -n $NAMESPACE --create-namespace --install
helm upgrade tyk-otel tyk-helm/tyk-oss -n $NAMESPACE --create-namespace --devel \
  --install \
  --set global.secrets.APISecret="$APISecret" \
  --set global.redis.addrs="{tyk-redis-master.$NAMESPACE.svc.cluster.local:6379}" \
  --set global.redis.pass="$(kubectl get secret --namespace $NAMESPACE tyk-redis -o jsonpath='{.data.redis-password}' | base64 -d)" \
  --set tyk-gateway.gateway.image.tag=$TykVersion \
  --set "tyk-gateway.gateway.extraEnvs[0].name=TYK_GW_OPENTELEMETRY_ENABLED" \
  --set-string "tyk-gateway.gateway.extraEnvs[0].value=true" \
  --set "tyk-gateway.gateway
```
